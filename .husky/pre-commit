#!/bin/sh

echo "ğŸ¨ Verificando arquivos alterados..."
FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.php$' || true)

if [ -z "$FILES" ]; then
  echo "âœ… Nenhum arquivo PHP alterado."
  exit 0
fi

echo
echo "ğŸ“„ Arquivos alterados:"
echo "$FILES"

FILES_LIST=$(echo "$FILES" | tr '\n' ' ')

if [ -z "$FILES_LIST" ]; then
  echo "âœ… Nenhum arquivo PHP encontrado nas alteraÃ§Ãµes! Pulando prÃ©-commit..."
  exit 0
fi

CONTAINER_NAME="app"

echo "ğŸ” Executando hooks de pre-commit..."

if ! docker ps --format '{{.Names}}' | grep -qx "$CONTAINER_NAME"; then
  echo "âŒ O container \"$CONTAINER_NAME\" nÃ£o estÃ¡ em execuÃ§Ã£o."
  echo "ğŸ‘‰ Sobe o ambiente antes de commitar (ex: docker compose up -d)."
  exit 1
fi

run_in_container() {
  docker exec "$CONTAINER_NAME" sh -lc "$1"
}

echo
echo "ğŸ§ª Executando php-cs-fixer (composer cs-fixer) em \"$CONTAINER_NAME\"..."
if ! run_in_container "composer cs-fixer"; then
  echo "âŒ 'composer cs-fixer' falhou. Commit cancelado."
  exit 1
fi

echo
echo "ğŸ§ª Executando testes (composer test) em \"$CONTAINER_NAME\"..."
if ! run_in_container "composer test"; then
  echo "âŒ 'composer test' falhou. Commit cancelado."
  exit 1
fi

echo
echo "ğŸ” Executando anÃ¡lise estÃ¡tica (composer stan) em \"$CONTAINER_NAME\"..."
if ! run_in_container "composer stan"; then
  echo "âŒ 'composer stan' falhou. Commit cancelado."
  exit 1
fi

echo
echo "ğŸš€ Tudo certo! Pre-commit finalizado com sucesso."