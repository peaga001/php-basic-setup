#!/bin/sh

CONTAINER_NAME="app"

echo "ğŸ” Executando hooks de pre-commit..."

# Verifica se o container estÃ¡ rodando
if ! docker ps --format '{{.Names}}' | grep -qx "$CONTAINER_NAME"; then
  echo "âŒ O container \"$CONTAINER_NAME\" nÃ£o estÃ¡ em execuÃ§Ã£o."
  echo "ğŸ‘‰ Sobe o ambiente antes de commitar (ex: docker compose up -d)."
  exit 1
fi

run_in_container() {
  docker exec "$CONTAINER_NAME" sh -lc "$1"
}

echo
echo "ğŸ§ª Executando testes (composer test) em \"$CONTAINER_NAME\"..."
if ! run_in_container "composer test"; then
  echo "âŒ 'composer test' falhou. Commit cancelado."
  exit 1
fi

echo
echo "ğŸ” Executando anÃ¡lise estÃ¡tica (composer stan) em \"$CONTAINER_NAME\"..."
if ! run_in_container "composer stan"; then
  echo "âŒ 'composer stan' falhou. Commit cancelado."
  exit 1
fi

echo
echo "ğŸš€ Tudo certo! Pre-commit finalizado com sucesso."